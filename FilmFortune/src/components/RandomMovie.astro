---
import { fetchJson } from "../functions/fetchJsonMWDP";

let randomMovie = null;
try {
  const MAX_PAGE = 500;
  const firstPageData = await fetchJson(
    "https://api.themoviedb.org/3/movie/popular"
  );
  const totalPages = Math.min(firstPageData.total_pages || 1, MAX_PAGE);
  const randomPage = Math.floor(Math.random() * totalPages) + 1;
  const randomPageData = await fetchJson(
    `https://api.themoviedb.org/3/movie/popular?page=${randomPage}`
  );
  const movies = randomPageData.results || [];
  randomMovie = movies[Math.floor(Math.random() * movies.length)];
} catch (err) {
  console.error(err);
}

const baseUrl = "https://image.tmdb.org/t/p/w500";
---

<section
  id="random-movie-section"
  class="relative flex flex-col items-center justify-center min-h-screen px-6 py-12 overflow-hidden bg-gray-900 text-white"
>
  {
    randomMovie?.backdrop_path && (
      <div
        class="absolute inset-0 bg-center bg-cover"
        id="backdrop"
        style={`background-image: url(${baseUrl + randomMovie.backdrop_path});`}
      >
        <div class="absolute inset-0  bg-opacity-70 backdrop-blur-sm" />
      </div>
    )
  }

  <div
    class="relative z-10 max-w-2xl w-full flex flex-col items-center space-y-6"
  >
    <h1 id="title" class="text-3xl md:text-4xl font-bold text-center">
      {randomMovie?.title}
    </h1>
    <div id="release" class="text-gray-300 text-sm">
      Released: {randomMovie?.release_date}
    </div>

    {
      randomMovie?.poster_path ? (
        <img
          id="poster"
          src={baseUrl + randomMovie.poster_path}
          alt={`Poster of ${randomMovie.title}`}
          class="rounded-lg shadow-lg max-w-xs w-full"
        />
      ) : (
        <p class="text-gray-400">No poster available</p>
      )
    }

    <p id="overview" class="mt-4 text-center text-gray-200">
      {randomMovie?.overview}
    </p>

    <button
      id="randomBtn"
      class="mt-6 px-5 py-2 rounded-md bg-blue-600 hover:bg-blue-700 transition-colors font-semibold"
    >
      Pick Another Random Movie
    </button>
  </div>
</section>

<script>
  const btn = document.getElementById("randomBtn");
  const titleEl = document.getElementById("title");
  const releaseEl = document.getElementById("release");
  const posterEl = document.getElementById("poster");
  const backdropEl = document.getElementById("backdrop");
  const overviewEl = document.getElementById("overview");

  const baseUrl = "https://image.tmdb.org/t/p/w500";

  btn.addEventListener("click", async () => {
    btn.disabled = true;
    btn.textContent = "Loading...";
    try {
      const res = await fetch("/api/random-movie");
      const movie = await res.json();

      titleEl.textContent = movie.title;
      releaseEl.textContent = "Released: " + movie.release_date;
      overviewEl.textContent = movie.overview || "";

      if (movie.poster_path) {
        posterEl.src = baseUrl + movie.poster_path;
        posterEl.alt = `Poster of ${movie.title}`;
      } else {
        posterEl.src = "";
        posterEl.alt = "No poster";
      }

      if (movie.backdrop_path) {
        backdropEl.style.backgroundImage = `url(${baseUrl + movie.backdrop_path})`;
      } else {
        backdropEl.style.backgroundImage = "";
      }
    } catch (err) {
      console.error(err);
      alert("Failed to get a random movie");
    }
    btn.disabled = false;
    btn.textContent = "Pick Another Random Movie";
  });
</script>
